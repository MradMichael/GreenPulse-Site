<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NASA Earth Climate Observatory - Interactive Mission Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght&display=swap" rel="stylesheet">
    <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Exo 2', sans-serif;
            background: radial-gradient(ellipse at center, #0f1419 0%, #000000 70%);
            color: #ffffff;
            overflow: hidden;
            position: relative;
        }

        /* Animated starfield background */
        .starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background:
                radial-gradient(2px 2px at 20px 30px, #eee, transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 90px 40px, #fff, transparent),
                radial-gradient(1px 1px at 130px 80px, rgba(255,255,255,0.6), transparent),
                radial-gradient(2px 2px at 160px 30px, #ddd, transparent);
            background-repeat: repeat;
            background-size: 200px 100px;
            animation: sparkle 20s linear infinite;
        }

        @keyframes sparkle {
            from { transform: translateY(0px); }
            to { transform: translateY(-100px); }
        }

        /* Beautiful floating particles */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -2;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #00ff00;
            border-radius: 50%;
            box-shadow: 0 0 10px #00ff00;
            animation: float 15s infinite linear;
        }

        .particle:nth-child(2n) {
            background: #00ffff;
            box-shadow: 0 0 10px #00ffff;
            animation-duration: 12s;
        }

        .particle:nth-child(3n) {
            background: #ffffff;
            box-shadow: 0 0 8px #ffffff;
            animation-duration: 18s;
            width: 2px;
            height: 2px;
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) translateX(0px) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-10vh) translateX(100px) rotate(360deg);
                opacity: 0;
            }
        }

        .container {
            display: flex;
            height: 100vh;
            position: relative;
            background: linear-gradient(45deg, rgba(0,100,200,0.1) 0%, rgba(0,50,150,0.1) 100%);
        }

        .map-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: radial-gradient(circle at center, #001122 0%, #000000 100%);
            border: 2px solid #90ff90;
            border-radius: 15px;
            margin: 10px;
            box-shadow:
                0 0 30px rgba(144,255,144,0.3),
                inset 0 0 30px rgba(0,100,50,0.1);
        }

        .earth-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: grab;
            transition: transform 0.3s ease;
            filter: brightness(1.2) contrast(1.1) saturate(1.3);
        }

        .earth-image:active {
            cursor: grabbing;
        }

        .zone-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .zone {
            position: absolute;
            border-radius: 50%;
            cursor: pointer;
            pointer-events: all;
            transition: all 0.3s ease;
            border: 2px solid rgba(255,255,255,0.8);
            backdrop-filter: blur(2px);
            animation: pulse 2s infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
            text-shadow: 0 0 10px rgba(0,0,0,0.8);
            /* Initial size override for dynamic scaling */
            width: 40px;
            height: 40px;
            line-height: 40px;
        }

        /* Specific positioning from original file, but removed specific size to allow dynamic scaling */
        #zone1 { top: 15%; left: 15%; }
        #zone2 { top: 45%; left: 25%; }
        #zone3 { top: 35%; left: 48%; }
        #zone4 { top: 25%; left: 48%; }
        #zone5 { top: 18%; left: 60%; }
        #zone6 { top: 40%; left: 75%; }
        #zone7 { top: 65%; left: 75%; }
        #zone8 { top: 45%; left: 50%; }
        #zone9 { top: 8%; left: 20%; }


        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 10px rgba(255,255,255,0.3); }
            50% { transform: scale(1.1); box-shadow: 0 0 20px rgba(255,255,255,0.6); }
        }

        .zone:hover {
            transform: scale(1.2) !important;
            box-shadow: 0 0 30px rgba(0,255,255,0.8) !important;
            border-color: #00ffff;
        }

        .zone.danger {
            background: radial-gradient(circle, rgba(255,0,0,0.8) 0%, rgba(255,100,100,0.4) 100%);
            box-shadow: 0 0 15px rgba(255,0,0,0.6);
            border-color: rgba(255,100,100,0.9);
        }

        .zone.moderate {
            background: radial-gradient(circle, rgba(255,165,0,0.8) 0%, rgba(255,200,100,0.4) 100%);
            box-shadow: 0 0 15px rgba(255,165,0,0.6);
            border-color: rgba(255,200,100,0.9);
        }

        .zone.healthy {
            background: radial-gradient(circle, rgba(0,255,0,0.8) 0%, rgba(100,255,100,0.4) 100%);
            box-shadow: 0 0 15px rgba(0,255,0,0.6);
            border-color: rgba(100,255,100,0.9);
        }

        .simple-title {
            position: absolute;
            top: 20px;
            left: 20px;
            font-family: 'Orbitron', monospace;
            font-size: 16px;
            font-weight: 900;
            color: #90ff90;
            text-shadow: 0 0 10px rgba(144,255,144,0.5);
            letter-spacing: 3px;
            z-index: 150;
            background: rgba(20,40,20,0.8);
            padding: 10px 20px;
            border-radius: 10px;
            border: 1px solid #90ff90;
            box-shadow: 0 0 20px rgba(144,255,144,0.3);
            backdrop-filter: blur(10px);
        }

        .controls {
            position: absolute;
            top: 80px;
                left: 20px;
            background: linear-gradient(135deg, rgba(0,40,20,0.95) 0%, rgba(0,100,50,0.9) 100%);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #90ff90;
            box-shadow:
                0 0 20px rgba(144,255,144,0.3),
                inset 0 0 20px rgba(0,100,50,0.1);
            z-index: 100;
            backdrop-filter: blur(10px);
            width: 200px;
            display: none; /* Hide static temporal control as it's not supported by V2.1 live data */
        }

        .controls h3 {
            font-family: 'Orbitron', monospace;
            color: #90ff90;
            margin: 0 0 10px 0;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 0 5px rgba(144,255,144,0.5);
        }
        /* Hidden elements from static version */
        .time-slider, .year-display { display: none; }


        .zoom-controls {
            position: absolute;
            top: 80px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }

        .zoom-btn {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, rgba(0,100,50,0.8) 0%, rgba(0,150,75,0.6) 100%);
            border: 2px solid #90ff90;
            border-radius: 50%;
            font-family: 'Orbitron', monospace;
            font-size: 20px;
            font-weight: bold;
            color: #ffffff;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(144,255,144,0.3);
        }

        .zoom-btn:hover {
            background: linear-gradient(135deg, rgba(0,150,75,0.9) 0%, rgba(0,200,100,0.7) 100%);
            box-shadow: 0 0 25px rgba(144,255,144,0.6);
            transform: scale(1.1);
        }

        .sidebar {
            width: 320px; /* Increased width for better content display */
            background: linear-gradient(180deg, rgba(0,30,10,0.95) 0%, rgba(0,60,30,0.9) 100%);
            backdrop-filter: blur(15px);
            padding: 20px;
            box-shadow: -5px 0 30px rgba(144,255,144,0.2);
            overflow-y: auto;
            transform: translateX(100%);
            transition: transform 0.4s ease;
            border-left: 2px solid #90ff90;
            position: relative;
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 20%, rgba(144,255,144,0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(144,255,144,0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .sidebar.active {
            transform: translateX(0);
        }

        .sidebar h2 {
            font-family: 'Orbitron', monospace;
            color: #90ff90;
            margin-bottom: 25px;
            font-size: 22px;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(144,255,144,0.5);
            border-bottom: 2px solid #90ff90;
            padding-bottom: 10px;
        }

        .info-section {
            margin-bottom: 25px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(0,100,50,0.3) 0%, rgba(0,50,20,0.5) 100%);
            border-radius: 12px;
            border: 1px solid rgba(144,255,144,0.3);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }

        .info-section h3 {
            font-family: 'Orbitron', monospace;
            margin: 0 0 15px 0;
            color: #ffffff;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stress-meter {
            width: 100%;
            height: 18px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
            border: 1px solid #00ff00;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        .stress-fill {
            height: 100%;
            transition: width 0.8s ease, background 0.8s ease; /* Added background transition */
            border-radius: 10px;
            background: linear-gradient(90deg, #00ff00 0%, #ffff00 50%, #ff0000 100%);
            box-shadow: 0 0 10px rgba(255,255,255,0.3);
        }

        .plant-legend {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .plant-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #ffffff;
            background: rgba(0,200,100,0.2);
            padding: 8px;
            border-radius: 8px;
            border: 1px solid rgba(0,255,0,0.2);
        }

        .vegetation-icon {
            font-size: 16px;
            margin-right: 5px;
        }

        .dominant-vegetation {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            background: rgba(0,255,150,0.2);
            border-radius: 8px;
            border: 1px solid rgba(144,255,144,0.3);
        }

        .dominant-vegetation .icon {
            font-size: 16px;
        }

        .dominant-vegetation .label {
            font-family: 'Orbitron', monospace;
            font-size: 11px;
            color: #90ff90;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(135deg, rgba(0,40,20,0.95) 0%, rgba(0,100,50,0.9) 100%);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #00ff00;
            box-shadow: 0 0 20px rgba(0,255,0,0.3);
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .legend h4 {
            font-family: 'Orbitron', monospace;
            color: #90ff90;
            margin: 0 0 15px 0;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 8px 0;
            font-size: 13px;
            color: #ffffff;
        }

        .legend-color {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
            box-shadow: 0 0 10px rgba(255,255,255,0.2);
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0,100,50,0.8);
            border: 2px solid #00ff00;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            color: #90ff90;
            font-family: 'Orbitron', monospace;
            transition: all 0.3s ease;
            z-index: 300;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 15px rgba(0,255,0,0.3);
        }

        .close-btn:hover {
            color: #ffffff;
            background: rgba(0,200,100,0.9);
            text-shadow: 0 0 10px rgba(0,255,0,0.8);
            transform: scale(1.1);
            box-shadow: 0 0 25px rgba(0,255,0,0.6);
        }

        .prediction {
            padding: 18px;
            border-radius: 10px;
            margin-top: 15px;
            border: 1px solid;
            position: relative;
            overflow: hidden;
        }

        .prediction::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: scan 3s infinite;
        }

        @keyframes scan {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .prediction.positive {
            background: linear-gradient(135deg, rgba(0,255,0,0.2) 0%, rgba(0,150,0,0.1) 100%);
            border-color: #00ff00;
            box-shadow: 0 0 15px rgba(0,255,0,0.2);
        }

        .prediction.negative {
            background: linear-gradient(135deg, rgba(255,0,0,0.2) 0%, rgba(150,0,0,0.1) 100%);
            border-color: #ff0000;
            box-shadow: 0 0 15px rgba(255,0,0,0.2);
        }

        .satellite-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #90ff90;
            font-family: 'Orbitron', monospace;
            font-size: 12px;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .data-stream {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-family: 'Orbitron', monospace;
            font-size: 10px;
            color: #90ff90;
            opacity: 0.7;
        }

        /* Holographic effect for zones */
        .zone::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border-radius: 50%;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            animation: hologram 4s linear infinite;
        }

        @keyframes hologram {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="starfield"></div>
    <div class="particles" id="particles"></div>

    <div class="simple-title">🌍 GREEN PULSE</div>

    <div class="container">
        <div class="map-container">
            <img src="https://eoimages.gsfc.nasa.gov/images/imagerecords/73000/73909/world.topo.bathy.200412.3x5400x2700.jpg"
                 alt="NASA Earth Satellite View"
                 class="earth-image"
                 id="earthImage"
                 onerror="this.src=''; this.alt='Loading satellite imagery...'; this.style.background='linear-gradient(45deg, #001122 0%, #003366 100%)'; this.style.display='block';">

            <div class="zone-overlay">
                <div class="zone healthy" id="zone1" data-zone="North American Forests">🌲</div>
                <div class="zone moderate" id="zone2" data-zone="Amazon Rainforest">🌳</div>
                <div class="zone danger" id="zone3" data-zone="Sahara Desert">🌵</div>
                <div class="zone healthy" id="zone4" data-zone="European Forests">🌳</div>
                <div class="zone moderate" id="zone5" data-zone="Siberian Taiga">🌲</div>
                <div class="zone danger" id="zone6" data-zone="SE Asian Rainforests">🌴</div>
                <div class="zone danger" id="zone7" data-zone="Australian Outback">🌿</div>
                <div class="zone moderate" id="zone8" data-zone="African Savanna">🌾</div>
                <div class="zone moderate" id="zone9" data-zone="Arctic Tundra">❄️</div>

            </div>

            <div class="satellite-indicator">🛰️ LANDSAT-9 ACTIVE</div>
            <div class="data-stream">DATA STREAM: 847.2 MB/s</div>

            <div class="controls" id="controls">
                <h3>🕐 Temporal Analysis</h3>
                <div class="year-display">DATA SOURCE: <span id="currentYear">LIVE EONET V2.1</span></div>
            </div>

            <div class="zoom-controls">
                <button class="zoom-btn" id="zoomIn">+</button>
                <button class="zoom-btn" id="zoomOut">−</button>
                <button class="zoom-btn" id="resetZoom">🌍</button>
            </div>

            <div class="legend">
                <h4>🌡️ Climate Stress Matrix (Percentage)</h4>
                <div class="legend-item">
                    <div class="legend-color" style="background: radial-gradient(circle, rgba(0,255,0,0.8) 0%, rgba(100,255,100,0.4) 100%);"></div>
                    <span>Optimal Ecosystem (Score < 15%)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: radial-gradient(circle, rgba(255,165,0,0.8) 0%, rgba(255,200,100,0.4) 100%);"></div>
                    <span>Moderate Stress (15% - 30%)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: radial-gradient(circle, rgba(255,0,0,0.8) 0%, rgba(255,100,100,0.4) 100%);"></div>
                    <span>Critical Alert (Score > 30%)</span>
                </div>
            </div>
        </div>

        <div class="sidebar" id="sidebar">
            <button class="close-btn" id="closeSidebar">✕</button>
            <h2 id="zoneName">🛰️ Select Target Zone</h2>

            <div class="info-section">
                <h3>🌡️ Climate Stress Analysis (EONET Data)</h3>
                <div class="stress-meter">
                    <div class="stress-fill" id="stressFill"></div>
                </div>
                <p id="stressPercent" style="color: #00ff00; font-family: 'Orbitron', monospace;">Loading live event data...</p>
            </div>

            <div class="info-section">
                <h3>🔥 Event Summary</h3>
                <p id="eventSummary" style="color: #ffffff;">No recent events detected.</p>
            </div>

            <div class="info-section">
                <h3>🌱 Biosphere Health Matrix (Static)</h3>
                <p id="plantHealth" style="color: #ffffff;">Ecosystem parameters based on mission profile.</p>
                <div class="plant-legend" id="plantLegend"></div>
            </div>

            <div class="info-section">
                <h3>🚀 Mission Recommendations (Static)</h3>
                <ul id="suggestions" style="color: #ffffff; padding-left: 20px;">
                    <li>Select zone for mission parameters</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // --- NASA EONET INTEGRATION (New Dynamic Logic) ---

        const EONET_API_URL = "https://eonet.gsfc.nasa.gov/api/v2.1/events?status=open&limit=500";

        // Maximum stress score used for normalization to 100%
        const MAX_STRESS_SCORE = 200;

        // Severity weights based on estimated impact (used to calculate Stress Score)
        const SEVERITY_WEIGHTS = {
            'Wildfires': 5,
            'Floods': 4,
            'Severe Storms': 4,
            'Volcanoes': 7,
            'Drought': 2,
            'Dust and Haze': 1,
            'Earthquakes': 6,
            'Landslides': 3,
            'Sea and Lake Ice': 1,
            'Manmade': 1,
            'Uncategorized': 1
        };

        // Geographic Bounding Boxes for the 9 Zones (minLon, minLat, maxLon, maxLat)
        const ZONES_BBOX = {
            "North American Forests": [-125, 25, -70, 60],
            "Amazon Rainforest": [-79, -20, -45, 6],
            "Sahara Desert": [-17, 15, 40, 35],
            "European Forests": [-10, 40, 60, 70],
            "Siberian Taiga": [30, 50, 180, 70],
            "SE Asian Rainforests": [95, -10, 150, 25],
            "Australian Outback": [115, -35, 150, -15],
            "African Savanna": [-18, -35, 50, 15],
            "Arctic Tundra": [-180, 65, 180, 85]
        };

        // Static descriptive data (kept from original to populate sidebar)
        const STATIC_ZONE_DATA = {
            "North American Forests": {
                name: "North American Boreal Forests", dominantVegetation: { icon: "🌲", type: "Coniferous Forest" },
                plants: ["🌲 Coniferous Biomass", "🍃 Deciduous Canopy", "🌿 Understory Matrix", "🦌 Wildlife Corridors"],
                suggestions: ["Deploy reforestation satellites", "Implement carbon sequestration protocols", "Activate forest monitoring network", "Launch biodiversity preservation mission"],
            },
            "Amazon Rainforest": {
                name: "Amazon Basin Critical Zone", dominantVegetation: { icon: "🌳", type: "Tropical Rainforest" },
                plants: ["🌳 Tropical Canopy", "🌿 Medicinal Flora", "🌺 Endemic Species", "🦋 Pollinator Network"],
                suggestions: ["Activate emergency conservation protocols", "Deploy deforestation monitoring satellites", "Implement indigenous protection programs", "Launch carbon offset initiatives"],
            },
            "Sahara Desert": {
                name: "Sahara Expansion Zone", dominantVegetation: { icon: "🌵", type: "Desert Biome" },
                plants: ["🌵 Desert Adaptation", "🌿 Xerophytic Species", "🦎 Arid Ecosystem"],
                suggestions: ["Deploy desert regreening technology", "Activate solar collection arrays", "Implement water conservation protocols", "Launch climate adaptation research"],
            },
            "European Forests": {
                name: "European Climate Sanctuary", dominantVegetation: { icon: "🌳", type: "Temperate Forest" },
                plants: ["🌳 Temperate Hardwoods", "🍂 Seasonal Adaptation", "🌿 Managed Understory", "🐝 Pollinator Hubs"],
                suggestions: ["Maintain Green Deal protocols", "Expand renewable energy grid", "Deploy urban forest networks", "Activate carbon neutrality systems"],
            },
            "Siberian Taiga": {
                name: "Siberian Taiga Monitoring Zone", dominantVegetation: { icon: "🌲", type: "Boreal Taiga" },
                plants: ["🌲 Boreal Conifers", "❄️ Permafrost Flora", "🐻 Arctic Megafauna", "🌨️ Tundra Transition"],
                suggestions: ["Deploy permafrost monitoring arrays", "Activate wildfire suppression systems", "Implement carbon sink protection", "Launch Arctic research stations"],
            },
            "SE Asian Rainforests": {
                name: "Southeast Asian Biodiversity Hotspot", dominantVegetation: { icon: "🌴", type: "Tropical Palms" },
                plants: ["🌴 Tropical Palms", "🌺 Endemic Orchids", "🦧 Primate Habitats", "🐅 Apex Predators"],
                suggestions: ["Emergency biodiversity protection", "Deploy anti-deforestation satellites", "Activate species preservation protocols", "Launch sustainable development programs"],
            },
            "Australian Outback": {
                name: "Australian Continental Monitoring", dominantVegetation: { icon: "🌿", type: "Scrubland" },
                plants: ["🌿 Fire-Adapted Flora", "🦘 Marsupial Habitats", "🌳 Eucalyptus Groves", "🔥 Recovery Zones"],
                suggestions: ["Deploy fire prevention satellites", "Activate species recovery programs", "Implement water security protocols", "Launch climate resilience initiatives"],
            },
            "African Savanna": {
                name: "African Savanna Corridor", dominantVegetation: { icon: "🌾", type: "Grassland Savanna" },
                plants: ["🌳 Acacia Networks", "🦁 Apex Predators", "🌾 Grassland Matrix", "🐘 Megafauna Corridors"],
                suggestions: ["Deploy wildlife tracking satellites", "Activate anti-poaching networks", "Implement water access systems", "Launch community conservation programs"],
            },
            "Arctic Tundra": {
                name: "Arctic Ice Monitoring Station", dominantVegetation: { icon: "❄️", type: "Arctic Tundra" },
                plants: ["❄️ Polar Vegetation", "🐻‍❄️ Arctic Megafauna", "🌨️ Tundra Ecosystems", "🧊 Ice-Dependent Species"],
                suggestions: ["Deploy ice monitoring satellites", "Activate polar bear protection", "Implement carbon reduction protocols", "Launch Arctic research missions"],
            },
        };

        // Global variable to store the live EONET data results
        let liveZoneData = {};

        // --- Geolocation Utility ---

        function isPointInBBox(lon, lat, bbox) {
            const [minLon, minLat, maxLon, maxLat] = bbox;
            return lon >= minLon && lon <= maxLon && lat >= minLat && lat <= maxLat;
        }

        function isEventInBBox(geometry, bbox) {
            if (!geometry) return false;

            for (const geo of geometry) {
                const coords = geo.coordinates;
                const type = geo.type;

                if (type === 'Point' && coords.length === 2) {
                    if (isPointInBBox(coords[0], coords[1], bbox)) return true;
                } else if (type === 'Polygon' && coords.length > 0) {
                    // Check if any part of the polygon is in the BBOX (simplified)
                    for (const ring of coords) {
                        for (const coordPair of ring) {
                            if (isPointInBBox(coordPair[0], coordPair[1], bbox)) return true;
                        }
                    }
                }
            }
            return false;
        }

        // --- Core Data Fetching and Stress Calculation ---

        async function fetchAndCalculateStress() {
            try {
                const response = await fetch(EONET_API_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                const events = data.events || [];

                const results = {};

                // 1. Initialize results structure for all zones
                for (const zoneName in ZONES_BBOX) {
                    results[zoneName] = {
                        stressScore: 0,
                        eventDetails: {},
                        totalEvents: 0
                    };
                }

                // 2. Process all events
                for (const event of events) {
                    const categoryName = event.categories[0]?.title || 'Uncategorized';
                    const weight = SEVERITY_WEIGHTS[categoryName] || SEVERITY_WEIGHTS['Uncategorized'];

                    // 3. Check for zone containment and accumulate score
                    for (const zoneName in ZONES_BBOX) {
                        if (isEventInBBox(event.geometries, ZONES_BBOX[zoneName])) {
                            // Accumulate stress score
                            results[zoneName].stressScore += weight;
                            results[zoneName].totalEvents += 1;

                            // Track event counts by category for the sidebar
                            if (!results[zoneName].eventDetails[categoryName]) {
                                results[zoneName].eventDetails[categoryName] = 0;
                            }
                            results[zoneName].eventDetails[categoryName] += 1;

                            // Important: An event can overlap multiple zones, but to prevent
                            // overcounting for the primary visualization, we break here.
                            // EONET events often cover wide areas.
                            break;
                        }
                    }
                }

                // 4. Determine class and health status (based on percentage)
                for (const zoneName in results) {
                    const score = results[zoneName].stressScore;

                    // Normalize the raw score to a percentage based on MAX_STRESS_SCORE
                    const stressPercentage = Math.min(100, Math.round((score / MAX_STRESS_SCORE) * 100));

                    let healthStatus = "Optimal Ecosystem Performance";
                    let cssClass = "healthy";

                    if (stressPercentage > 30) {
                        cssClass = "danger";
                        healthStatus = "CRITICAL: High Cumulative Stress Detected";
                    } else if (stressPercentage > 15) {
                        cssClass = "moderate";
                        healthStatus = "WARNING: Moderate Stress Zone";
                    } else {
                        cssClass = "healthy";
                        healthStatus = "Optimal Ecosystem Performance";
                    }

                    results[zoneName].stressPercentage = stressPercentage; // Store percentage
                    results[zoneName].health = healthStatus;
                    results[zoneName].class = cssClass;
                }

                liveZoneData = results;
                updateMapVisualization();

            } catch (error) {
                console.error("EONET API or calculation failed:", error);
                document.getElementById('stressPercent').textContent = "ERROR: Failed to load live EONET data.";
            }
        }

        // --- Visualization & Interaction ---

        function updateMapVisualization() {
            document.querySelectorAll('.zone').forEach(zoneElement => {
                const zoneName = zoneElement.getAttribute('data-zone');
                const data = liveZoneData[zoneName];

                if (data) {
                    // Update CSS class for color/pulse
                    zoneElement.className = `zone ${data.class}`;

                    // Dynamic Size: Scale by event count (e.g., 40px base + 2px per event up to a max)
                    const baseSize = 40;
                    const maxEvents = 50;
                    const size = Math.min(baseSize + data.totalEvents * 2, baseSize + maxEvents * 2);
                    zoneElement.style.width = `${size}px`;
                    zoneElement.style.height = `${size}px`;
                    zoneElement.style.lineHeight = `${size}px`;

                    zoneElement.title = `${zoneName}: ${data.health} (Stress: ${data.stressPercentage}%, Raw Score: ${data.stressScore}, Events: ${data.totalEvents})`;
                }
            });
            document.getElementById('stressPercent').textContent = "LIVE EONET DATA LOADED.";
            document.getElementById('controls').style.display = 'block';
        }

        function showZoneInfo(zoneElement) {
            const zoneName = zoneElement.getAttribute('data-zone');
            const liveData = liveZoneData[zoneName];
            const staticData = STATIC_ZONE_DATA[zoneName];

            if (!liveData || !staticData) return;

            // 1. Update Zone Name
            document.getElementById('zoneName').textContent = `🛰️ ${staticData.name}`;

            // 2. Stress Analysis
            const stressFill = document.getElementById('stressFill');
            const stressPercentElement = document.getElementById('stressPercent');

            // Use the pre-calculated percentage
            const percentage = liveData.stressPercentage;
            const score = liveData.stressScore;

            stressFill.style.width = `${percentage}%`;

            // Dynamic color logic for the fill bar
            if (percentage > 30) {
                stressFill.style.background = 'linear-gradient(90deg, #ff0000 0%, #ff6600 100%)';
            } else if (percentage > 15) {
                stressFill.style.background = 'linear-gradient(90deg, #ffaa00 0%, #ffdd00 100%)';
            } else {
                stressFill.style.background = 'linear-gradient(90deg, #00ff00 0%, #66ff66 100%)';
            }

            stressPercentElement.textContent = `${percentage}% STRESS LEVEL - ${liveData.health.toUpperCase()} (Raw Score: ${score})`;

            // 3. Event Summary
            const eventDetails = liveData.eventDetails;
            let eventHtml = '';

            if (liveData.totalEvents > 0) {
                eventHtml += `<p>Total Open Events: <strong>${liveData.totalEvents}</strong></p><ul>`;
                for (const category in eventDetails) {
                    eventHtml += `<li>${category}: <strong>${eventDetails[category]}</strong> (Weight: ${SEVERITY_WEIGHTS[category] || 1})</li>`;
                }
                eventHtml += '</ul>';
            } else {
                eventHtml = '<p>No recent EONET events detected in this zone.</p>';
            }
            document.getElementById('eventSummary').innerHTML = eventHtml;

            // 4. Biosphere Health (Static Descriptive Data)
            document.getElementById('plantHealth').innerHTML = `
                <div class="dominant-vegetation">
                    <div class="icon">${staticData.dominantVegetation.icon}</div>
                    <div class="label">${staticData.dominantVegetation.type}</div>
                </div>
                System Status: ${liveData.health}
            `;

            const plantLegend = document.getElementById('plantLegend');
            plantLegend.innerHTML = staticData.plants.map(plant =>
                `<div class="plant-item">${plant}</div>`
            ).join('');

            // 5. Mission-style Suggestions (Static Descriptive Data)
            const suggestions = document.getElementById('suggestions');
            suggestions.innerHTML = staticData.suggestions.map(suggestion =>
                `<li>🚀 ${suggestion}</li>`
            ).join('');

            // Show sidebar with animation
            sidebar.classList.add('active');
        }


        // --- Original Pan/Zoom/UI Controls (Kept intact) ---

        let currentZoom = 1;
        let isDragging = false;
        let startX, startY, currentX = 0, currentY = 0;

        const earthImage = document.getElementById('earthImage');
        const sidebar = document.getElementById('sidebar');

        // Zone Click Handler
        document.querySelectorAll('.zone').forEach(zone => {
            zone.addEventListener('click', (e) => {
                showZoneInfo(e.target);
            });
        });

        // Close Sidebar Handler
        document.getElementById('closeSidebar').addEventListener('click', () => {
            sidebar.classList.remove('active');
        });

        // Zoom Controls
        document.getElementById('zoomIn').addEventListener('click', () => {
            currentZoom = Math.min(currentZoom * 1.3, 4);
            updateMapTransform();
        });

        document.getElementById('zoomOut').addEventListener('click', () => {
            currentZoom = Math.max(currentZoom / 1.3, 0.8);
            updateMapTransform();
        });

        document.getElementById('resetZoom').addEventListener('click', () => {
            currentZoom = 1;
            currentX = 0;
            currentY = 0;
            updateMapTransform();
        });

        // Pan/Drag Functionality
        earthImage.addEventListener('mousedown', (e) => {
            isDragging = true;
            startX = e.clientX - currentX;
            startY = e.clientY - currentY;
            earthImage.style.cursor = 'grabbing';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            currentX = e.clientX - startX;
            currentY = e.clientY - startY;
            updateMapTransform();
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
            earthImage.style.cursor = 'grab';
        });

        // Wheel Zoom
        earthImage.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            currentZoom = Math.max(0.8, Math.min(4, currentZoom * delta));
            updateMapTransform();
        });

        function updateMapTransform() {
            earthImage.style.transform = `translate(${currentX}px, ${currentY}px) scale(${currentZoom})`;

            // Update zone overlay to match map transform
            const zoneOverlay = document.querySelector('.zone-overlay');
            zoneOverlay.style.transform = `translate(${currentX}px, ${currentY}px) scale(${currentZoom})`;
        }

        // Initialize dynamic data fetching on load
        fetchAndCalculateStress();

        // Add periodic satellite data updates (original function)
        setInterval(() => {
            const dataStream = document.querySelector('.data-stream');
            const speed = (Math.random() * 200 + 700).toFixed(1);
            dataStream.textContent = `DATA STREAM: ${speed} MB/s`;
        }, 2000);

        // Create beautiful floating particles (original function)
        function createParticles() {
            const particlesContainer = document.getElementById('particles');

            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 15 + 's';
                particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // Initialize particles
        createParticles();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98941920003ae30e',t:'MTc1OTU3NDgxNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
