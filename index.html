<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GREEN PULSE ‚Äî Interactive Climate Map</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;600&display=swap" rel="stylesheet">

  <!-- Leaflet (for MPC tiles) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --neon:#90ff90;
      --bg1:#0f1419;
      --bg2:#000;
      --panel1:rgba(0,40,20,.95);
      --panel2:rgba(0,100,50,.9);
      --ok:#09d36a;
    }

    /* Base */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; padding:0;
      font-family:'Exo 2', sans-serif;
      background: radial-gradient(ellipse at center, var(--bg1) 0%, var(--bg2) 70%);
      color:#fff; overflow:hidden; position:relative;
    }

    /* Starfield + particles (lighter) */
    .starfield{position:fixed; inset:0; z-index:-3;
      background:
        radial-gradient(2px 2px at 20px 30px,#eee,transparent),
        radial-gradient(2px 2px at 40px 70px,rgba(255,255,255,.8),transparent),
        radial-gradient(1px 1px at 90px 40px,#fff,transparent),
        radial-gradient(1px 1px at 130px 80px,rgba(255,255,255,.6),transparent),
        radial-gradient(2px 2px at 160px 30px,#ddd,transparent);
      background-size:200px 100px; animation:sparkle 24s linear infinite; opacity:.6;}
    @keyframes sparkle{from{transform:translateY(0)} to{transform:translateY(-120px)}}

    .particles{position:fixed; inset:0; pointer-events:none; z-index:-2}
    .particle{position:absolute; width:3px; height:3px; border-radius:50%;
      background:#00ff88; box-shadow:0 0 8px #00ff88; animation:float 18s linear infinite; opacity:.85}
    .particle:nth-child(2n){background:#00e0ff; box-shadow:0 0 8px #00e0ff; animation-duration:16s;}
    .particle:nth-child(3n){background:#ffffff; box-shadow:0 0 6px #ffffff; width:2px; height:2px; animation-duration:20s;}
    @keyframes float{0%{transform:translateY(100vh) translateX(0) rotate(0); opacity:0} 10%{opacity:1} 90%{opacity:1}
      100%{transform:translateY(-10vh) translateX(80px) rotate(360deg); opacity:0}}

    /* Layout */
    .container{display:flex; height:100vh; position:relative; background:linear-gradient(45deg,rgba(0,100,200,.08) 0%, rgba(0,50,150,.08) 100%)}
    .map-container{
      position:relative; flex:1; margin:10px; overflow:hidden; border:2px solid var(--neon); border-radius:15px;
      box-shadow:0 0 30px rgba(144,255,144,.3), inset 0 0 30px rgba(0,100,50,.1);
      background: radial-gradient(circle at center, #001122 0%, #000 100%);
    }

    /* Basemap stack */
    #mpcMap{position:absolute; inset:0; z-index:0}
    /* Local fallback image if needed */
    .earth-fallback{
      position:absolute; inset:0; z-index:0; display:none;
      background-image:
        url('earth.jpg'),
        url('https://eoimages.gsfc.nasa.gov/images/imagerecords/73000/73909/world.topo.bathy.200412.3x5400x2700.jpg'),
        radial-gradient(circle at center, #001122 0%, #003366 100%);
      background-size:cover; background-position:center; background-repeat:no-repeat;
      filter:brightness(1.15) contrast(1.08) saturate(1.2);
    }

    /* Overlay with zones that follow the map */
    .zone-overlay{position:absolute; inset:0; z-index:10; pointer-events:none}
    .zone{
      position:absolute; transform:translate(-50%, -50%); /* center on lat/lon */
      border-radius:50%; cursor:pointer; pointer-events:auto;
      transition:transform .25s ease, box-shadow .25s ease, border-color .25s ease;
      border:2px solid rgba(255,255,255,.85);
      display:flex; align-items:center; justify-content:center;
      font-size:24px; color:#fff; text-shadow:0 0 8px rgba(0,0,0,.8);
      box-shadow:0 0 12px rgba(255,255,255,.25); width:80px; height:80px;
      background: radial-gradient(circle, rgba(0,255,0,.8) 0%, rgba(100,255,100,.4) 100%);
    }
    .zone:hover{transform:translate(-50%,-50%) scale(1.15); box-shadow:0 0 18px rgba(0,255,255,.7); border-color:#00ffff}
    .zone.healthy{background: radial-gradient(circle, rgba(0,255,0,.8) 0%, rgba(100,255,100,.4) 100%)}
    .zone.moderate{background: radial-gradient(circle, rgba(255,165,0,.8) 0%, rgba(255,200,100,.4) 100%)}
    .zone.danger{background: radial-gradient(circle, rgba(255,0,0,.8) 0%, rgba(255,100,100,.4) 100%)}
    .zone::after{content:''; position:absolute; inset:-2px; border-radius:50%;
      background:linear-gradient(45deg, transparent 30%, rgba(255,255,255,.1) 50%, transparent 70%);
      animation:holo 4s linear infinite}
    @keyframes holo{to{transform:rotate(360deg)}}

    .simple-title{
      position:absolute; top:20px; left:20px; z-index:100;
      font-family:'Orbitron', monospace; font-size:24px; font-weight:900; letter-spacing:3px;
      color:var(--neon); background:rgba(20,40,20,.85); padding:10px 20px; border-radius:10px;
      border:1px solid var(--neon); box-shadow:0 0 20px rgba(144,255,144,.3);
    }

    .satellite-indicator{position:absolute; top:10px; right:10px; z-index:100; color:var(--neon); font-family:'Orbitron', monospace; font-size:12px; animation:blink 1.5s infinite}
    @keyframes blink{0%,50%{opacity:1} 51%,100%{opacity:.3}}
    .data-stream{position:absolute; bottom:10px; right:10px; z-index:100; font-family:'Orbitron', monospace; font-size:10px; color:var(--neon); opacity:.75}

    .controls{position:absolute; top:84px; left:20px; z-index:100; width:220px;
      background:linear-gradient(135deg, var(--panel1) 0%, var(--panel2) 100%); padding:14px; border-radius:10px; border:1px solid var(--neon); box-shadow:0 0 18px rgba(144,255,144,.28)}
    .controls h3{margin:0 0 8px 0; font-family:'Orbitron', monospace; color:var(--neon); font-size:12px; text-transform:uppercase; letter-spacing:1px}
    .time-slider{width:180px; margin:8px 0; -webkit-appearance:none; appearance:none; height:6px; border-radius:3px;
      background:linear-gradient(90deg,#ff0000 0%,#ffff00 50%,#00ff00 100%)}
    .time-slider::-webkit-slider-thumb{-webkit-appearance:none; appearance:none; width:18px; height:18px; border-radius:50%; background:var(--neon); box-shadow:0 0 8px var(--neon); cursor:pointer}
    .year-display{font-family:'Orbitron', monospace; font-size:13px; color:var(--neon); margin-top:6px}

    .legend{position:absolute; left:20px; bottom:20px; z-index:100; background:linear-gradient(135deg, var(--panel1) 0%, var(--panel2) 100%); padding:16px; border-radius:12px; border:1px solid #00ff00; box-shadow:0 0 18px rgba(144,255,144,.28)}
    .legend h4{font-family:'Orbitron', monospace; color:var(--neon); margin:0 0 10px 0; font-size:13px; text-transform:uppercase; letter-spacing:1px}
    .legend-item{display:flex; align-items:center; gap:10px; margin:8px 0; font-size:13px}
    .legend-color{width:22px; height:22px; border-radius:50%; border:2px solid rgba(255,255,255,.25)}

    .zoom-controls{position:absolute; top:84px; right:20px; display:flex; flex-direction:column; gap:10px; z-index:100}
    .zoom-btn{width:48px; height:48px; border-radius:50%; border:2px solid var(--neon);
      background:linear-gradient(135deg, rgba(0,100,50,.8) 0%, rgba(0,150,75,.6) 100%);
      font-family:'Orbitron', monospace; font-size:20px; font-weight:700; color:#fff; cursor:pointer; transition:transform .2s ease; box-shadow:0 0 18px rgba(144,255,144,.28)}
    .zoom-btn:hover{transform:scale(1.07)}

    /* Sidebar */
    .sidebar{width:310px; background:linear-gradient(180deg, rgba(0,30,10,.96) 0%, rgba(0,60,30,.92) 100%);
      padding:20px; box-shadow:-5px 0 24px rgba(144,255,144,.18); overflow-y:auto; transform:translateX(100%); transition:transform .35s ease;
      border-left:2px solid var(--neon); position:relative}
    .sidebar.active{transform:translateX(0)}
    .sidebar h2{font-family:'Orbitron', monospace; color:var(--neon); margin:0 0 18px 0; font-size:22px; text-transform:uppercase; letter-spacing:2px; border-bottom:2px solid var(--neon); padding-bottom:8px}
    .close-btn{position:absolute; top:14px; right:14px; width:40px; height:40px; border-radius:50%; border:2px solid #00ff00;
      background:rgba(0,100,50,.8); color:var(--neon); font-size:22px; cursor:pointer; box-shadow:0 0 18px rgba(144,255,144,.28)}

    .info-section{margin-bottom:20px; padding:16px; background:linear-gradient(135deg, rgba(0,100,50,.28) 0%, rgba(0,50,20,.45) 100%); border:1px solid rgba(144,255,144,.28); border-radius:10px}
    .info-section h3{margin:0 0 12px 0; font-family:'Orbitron', monospace; font-size:13px; text-transform:uppercase}
    .stress-meter{width:100%; height:16px; border-radius:9px; overflow:hidden; background:rgba(0,0,0,.45); border:1px solid #00ff00}
    .stress-fill{height:100%; transition:width .6s ease; border-radius:9px; background:linear-gradient(90deg, #00ff00 0%, #ffff00 50%, #ff0000 100%)}
    .plant-legend{display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:10px}
    .plant-item{display:flex; align-items:center; gap:8px; font-size:12px; background:rgba(0,200,100,.18); padding:8px; border-radius:8px; border:1px solid rgba(0,255,0,.18)}
    .dominant-vegetation{display:flex; align-items:center; gap:8px; margin-top:8px; padding:10px; background:rgba(0,255,150,.16); border-radius:8px; border:1px solid rgba(144,255,144,.28)}
    .dominant-vegetation .icon{font-size:22px}
    .dominant-vegetation .label{font-family:'Orbitron', monospace; font-size:11px; color:var(--neon); text-transform:uppercase; letter-spacing:1px}
  </style>
</head>
<body>
  <div class="starfield"></div>
  <div class="particles" id="particles"></div>

  <div class="simple-title">üåç GREEN PULSE</div>

  <div class="container">
    <div class="map-container" id="mapContainer">
      <!-- Basemap via Leaflet (MPC tiles) -->
      <div id="mpcMap"></div>

      <!-- Local fallback image (shows only if MPC tile fails) -->
      <div class="earth-fallback" id="earthFallback"></div>

      <!-- Overlay zones driven by lat/lon -->
      <div class="zone-overlay" id="zoneOverlay">
        <div class="zone healthy"  id="zone1" data-zone="North American Forests">üå≤</div>
        <div class="zone moderate" id="zone2" data-zone="Amazon Rainforest">üå≥</div>
        <div class="zone danger"   id="zone3" data-zone="Sahara Desert">üåµ</div>
        <div class="zone healthy"  id="zone4" data-zone="European Forests">üå≥</div>
        <div class="zone moderate" id="zone5" data-zone="Siberian Taiga">üå≤</div>
        <div class="zone danger"   id="zone6" data-zone="SE Asian Rainforests">üå¥</div>
        <div class="zone danger"   id="zone7" data-zone="Australian Outback">üåø</div>
        <div class="zone moderate" id="zone8" data-zone="African Savanna">üåæ</div>
        <div class="zone moderate" id="zone9" data-zone="Arctic Tundra">‚ùÑÔ∏è</div>
      </div>

      <div class="satellite-indicator" id="satelliteIndicator">üõ∞Ô∏è Sentinel-2 on MPC</div>
      <div class="data-stream" id="dataStream">DATA STREAM: 847.2 MB/s</div>

      <div class="controls" id="controls" style="display:none;">
        <h3>üïê Temporal Analysis</h3>
        <label for="timeSlider">Satellite Archive:</label>
        <input type="range" id="timeSlider" class="time-slider" min="2014" max="2025" value="2025"/>
        <div class="year-display">YEAR: <span id="currentYear">2025</span></div>
      </div>

      <div class="zoom-controls">
        <button class="zoom-btn" id="zoomIn">+</button>
        <button class="zoom-btn" id="zoomOut">‚àí</button>
        <button class="zoom-btn" id="resetZoom">üåç</button>
      </div>

      <div class="legend">
        <h4>üå°Ô∏è Climate Stress Matrix</h4>
        <div class="legend-item"><div class="legend-color" style="background: radial-gradient(circle, rgba(0,255,0,.8) 0%, rgba(100,255,100,.4) 100%);"></div><span>Optimal Ecosystem</span></div>
        <div class="legend-item"><div class="legend-color" style="background: radial-gradient(circle, rgba(255,165,0,.8) 0%, rgba(255,200,100,.4) 100%);"></div><span>Moderate Stress</span></div>
        <div class="legend-item"><div class="legend-color" style="background: radial-gradient(circle, rgba(255,0,0,.8) 0%, rgba(255,100,100,.4) 100%);"></div><span>Critical Alert</span></div>
      </div>
    </div>

    <div class="sidebar" id="sidebar">
      <button class="close-btn" id="closeSidebar">‚úï</button>
      <h2 id="zoneName">üõ∞Ô∏è Select Target Zone</h2>

      <div class="info-section">
        <h3>üå°Ô∏è Climate Stress Analysis</h3>
        <div class="stress-meter"><div class="stress-fill" id="stressFill"></div></div>
        <p id="stressPercent" style="color: var(--ok); font-family:'Orbitron', monospace;">Awaiting satellite data...</p>
      </div>

      <div class="info-section">
        <h3>üå± Biosphere Health Matrix</h3>
        <p id="plantHealth">Scanning ecosystem parameters...</p>
        <div class="plant-legend" id="plantLegend"></div>
      </div>

      <div class="info-section">
        <h3>üöÄ Mission Recommendations</h3>
        <ul id="suggestions" style="padding-left:20px;"><li>Select zone for mission parameters</li></ul>
      </div>

      <div class="info-section">
        <h3>üîÆ Predictive Analysis (T+6 Months)</h3>
        <div class="prediction" id="prediction"><p>AI prediction model loading...</p></div>
      </div>
    </div>
  </div>

  <script>
    /* ---------- particles ---------- */
    (function createParticles(){
      const c = document.getElementById('particles');
      const n = 16;
      for(let i=0;i<n;i++){
        const p = document.createElement('div');
        p.className='particle';
        p.style.left=(Math.random()*100)+'%';
        p.style.animationDelay=(Math.random()*16)+'s';
        p.style.animationDuration=(Math.random()*8+12)+'s';
        c.appendChild(p);
      }
    })();

    /* ---------- ZONE DATA (your existing content) ---------- */
    const zoneData = {
      zone1:{ name:"North American Boreal Forests", dominantVegetation:{icon:"üå≤", type:"Coniferous Forest"},
        data:{2025:{stress:25,health:"Stable Ecosystem", "class":"healthy"},2020:{stress:20,health:"Optimal Conditions","class":"healthy"},2016:{stress:15,health:"Peak Performance","class":"healthy"},2014:{stress:12,health:"Pristine State","class":"healthy"}},
        plants:["üå≤ Coniferous Biomass","üçÉ Deciduous Canopy","üåø Understory Matrix","ü¶å Wildlife Corridors"],
        suggestions:["Deploy reforestation satellites","Implement carbon sequestration protocols","Activate forest monitoring network","Launch biodiversity preservation mission"],
        prediction:{trend:"positive", text:"Satellite data indicates successful conservation protocols. Forest biomass projected to increase 8%."}
      },
      zone2:{ name:"Amazon Basin Critical Zone", dominantVegetation:{icon:"üå≥", type:"Tropical Rainforest"},
        data:{2025:{stress:65,health:"System Degradation","class":"moderate"},2020:{stress:55,health:"Moderate Decline","class":"moderate"},2016:{stress:45,health:"Stable Operations","class":"healthy"},2014:{stress:35,health:"Optimal Function","class":"healthy"}},
        plants:["üå≥ Tropical Canopy","üåø Medicinal Flora","üå∫ Endemic Species","ü¶ã Pollinator Network"],
        suggestions:["Activate emergency conservation protocols","Deploy deforestation monitoring satellites","Implement indigenous protection programs","Launch carbon offset initiatives"],
        prediction:{trend:"negative", text:"ALERT: Deforestation rates exceed sustainable thresholds. Stress may increase 12%."}
      },
      zone3:{ name:"Sahara Expansion Zone", dominantVegetation:{icon:"üåµ", type:"Desert Biome"},
        data:{2025:{stress:85,health:"Critical System Failure","class":"danger"},2020:{stress:80,health:"Severe Degradation","class":"danger"},2016:{stress:75,health:"System Stress","class":"danger"},2014:{stress:70,health:"Declining Function","class":"danger"}},
        plants:["üåµ Desert Adaptation","üåø Xerophytic Species","ü¶é Arid Ecosystem"],
        suggestions:["Deploy desert regreening technology","Activate solar collection arrays","Implement water conservation protocols","Launch climate adaptation research"],
        prediction:{trend:"negative", text:"CRITICAL: Accelerating desertification detected. Stress may increase 15%."}
      },
      zone4:{ name:"European Climate Sanctuary", dominantVegetation:{icon:"üå≥", type:"Temperate Forest"},
        data:{2025:{stress:30,health:"Managed Ecosystem","class":"healthy"},2020:{stress:25,health:"Stable Operations","class":"healthy"},2016:{stress:22,health:"Optimal Performance","class":"healthy"},2014:{stress:18,health:"Peak Efficiency","class":"healthy"}},
        plants:["üå≥ Temperate Hardwoods","üçÇ Seasonal Adaptation","üåø Managed Understory","üêù Pollinator Hubs"],
        suggestions:["Maintain Green Deal protocols","Expand renewable energy grid","Deploy urban forest networks","Activate carbon neutrality systems"],
        prediction:{trend:"positive", text:"SUCCESS: Policies show measurable results. Stress projected to decrease ~5%."}
      },
      zone5:{ name:"Siberian Taiga Monitoring Zone", dominantVegetation:{icon:"üå≤", type:"Boreal Taiga"},
        data:{2025:{stress:50,health:"Climate Adaptation","class":"moderate"},2020:{stress:45,health:"Moderate Stress","class":"moderate"},2016:{stress:35,health:"Stable Function","class":"healthy"},2014:{stress:30,health:"Optimal State","class":"healthy"}},
        plants:["üå≤ Boreal Conifers","‚ùÑÔ∏è Permafrost Flora","üêª Arctic Megafauna","üå®Ô∏è Tundra Transition"],
        suggestions:["Deploy permafrost monitoring arrays","Activate wildfire suppression systems","Protect carbon sinks","Launch Arctic research stations"],
        prediction:{trend:"negative", text:"WARNING: Rapid warming in permafrost zones. Stress may rise 10%."}
      },
      zone6:{ name:"Southeast Asian Biodiversity Hotspot", dominantVegetation:{icon:"üå¥", type:"Tropical Palms"},
        data:{2025:{stress:75,health:"Ecosystem Collapse Risk","class":"danger"},2020:{stress:70,health:"Severe Degradation","class":"danger"},2016:{stress:60,health:"System Stress","class":"moderate"},2014:{stress:50,health:"Moderate Function","class":"moderate"}},
        plants:["üå¥ Tropical Palms","üå∫ Endemic Orchids","ü¶ß Primate Habitats","üêÖ Apex Predators"],
        suggestions:["Emergency biodiversity protection","Anti-deforestation satellites","Species preservation protocols","Sustainable development programs"],
        prediction:{trend:"negative", text:"CRITICAL ALERT: Biodiversity loss accelerating."}
      },
      zone7:{ name:"Australian Continental Monitoring", dominantVegetation:{icon:"üåø", type:"Scrubland"},
        data:{2025:{stress:80,health:"Fire Recovery Phase","class":"danger"},2020:{stress:75,health:"Post-Fire Trauma","class":"danger"},2016:{stress:65,health:"Drought Stress","class":"moderate"},2014:{stress:55,health:"Stable Arid System","class":"moderate"}},
        plants:["üåø Fire-Adapted Flora","ü¶ò Marsupial Habitats","üå≥ Eucalyptus Groves","üî• Recovery Zones"],
        suggestions:["Fire prevention satellites","Species recovery programs","Water security protocols","Resilience initiatives"],
        prediction:{trend:"negative", text:"Extreme weather increasing; stress may rise 12%."}
      },
      zone8:{ name:"African Savanna Corridor", dominantVegetation:{icon:"üåæ", type:"Grassland Savanna"},
        data:{2025:{stress:55,health:"Migration Adaptation","class":"moderate"},2020:{stress:50,health:"Seasonal Stress","class":"moderate"},2016:{stress:45,health:"Stable Ecosystem","class":"healthy"},2014:{stress:40,health:"Optimal Function","class":"healthy"}},
        plants:["üå≥ Acacia Networks","ü¶Å Apex Predators","üåæ Grassland Matrix","üêò Megafauna Corridors"],
        suggestions:["Wildlife tracking satellites","Anti-poaching networks","Water access systems","Community conservation"],
        prediction:{trend:"positive", text:"Conservation initiatives stabilizing stress (~3%)."}
      },
      zone9:{ name:"Arctic Ice Monitoring Station", dominantVegetation:{icon:"‚ùÑÔ∏è", type:"Arctic Tundra"},
        data:{2025:{stress:70,health:"Rapid Ice Loss","class":"moderate"},2020:{stress:60,health:"Accelerating Melt","class":"moderate"},2016:{stress:45,health:"Seasonal Variation","class":"moderate"},2014:{stress:35,health:"Stable Ice Sheet","class":"healthy"}},
        plants:["‚ùÑÔ∏è Polar Vegetation","üêª‚Äç‚ùÑÔ∏è Arctic Megafauna","üå®Ô∏è Tundra Ecosystems","üßä Ice-Dependent Species"],
        suggestions:["Ice monitoring satellites","Polar bear protection","Carbon reduction protocols","Arctic research missions"],
        prediction:{trend:"negative", text:"Accelerating ice melt; tipping point approaching."}
      }
    };

    /* ---------- ZONE COORDS (lat/lon) ---------- */
    const zoneCoords = {
      zone1:{lat:56.0, lon:-106.0},  // North American Boreal
      zone2:{lat:-3.0, lon:-60.0},   // Amazon
      zone3:{lat:23.5, lon:13.0},    // Sahara
      zone4:{lat:50.0, lon:8.0},     // Europe
      zone5:{lat:62.0, lon:100.0},   // Siberia
      zone6:{lat:2.0,  lon:110.0},   // SE Asia
      zone7:{lat:-23.0,lon:133.0},   // Australia
      zone8:{lat:-2.0, lon:34.0},    // Savanna
      zone9:{lat:72.0, lon:-40.0}    // Arctic
    };

    /* ---------- MPC TILE HELPERS ---------- */

    // Find a Sentinel-2 L2A item near an AOI and date range via STAC
    async function stacSearch(bbox, datetime, collection="sentinel-2-l2a"){
      const url = "https://planetarycomputer.microsoft.com/api/stac/v1/search";
      const body = { bbox, datetime, collections:[collection], limit:1, query:{"eo:cloud_cover":{lt:20}} };
      const res = await fetch(url, {method:"POST", headers:{"content-type":"application/json"}, body:JSON.stringify(body)});
      if(!res.ok) throw new Error("STAC search failed");
      const json = await res.json();
      if(!json.features?.length) throw new Error("No items found");
      return json.features[0];
    }

    // Get a TileJSON for that item via MPC Data API (TiTiler wrapper)
    async function getTileJSON(collectionId, itemId, assets=["visual"]){
      const base = "https://planetarycomputer.microsoft.com/api/data/v1";
      const params = new URLSearchParams({ assets: assets.join(",") });
      const url = `${base}/collections/${collectionId}/items/${itemId}/tilejson.json?${params}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error("TileJSON fetch failed");
      return res.json();
    }

    /* ---------- LEAFLET MAP + ZONE POSITIONING ---------- */
    let map, tileLayer;

    async function initMap(){
      const mapEl = document.getElementById('mpcMap');
      map = L.map(mapEl, {zoomControl:false, minZoom:2, worldCopyJump:true}).setView([20,0], 2);

      // Try MPC; if it fails, use fallback image
      try{
        // AOI near Middle East to get something with low cloud as a sample
        const bbox = [ -10, -60, 170, 70 ]; // wide world bbox to find something quickly
        const start = new Date(); const end = new Date();
        start.setMonth(start.getMonth()-2);
        const datetime = `${start.toISOString().slice(0,10)}/${end.toISOString().slice(0,10)}`;

        const item = await stacSearch(bbox, datetime, "sentinel-2-l2a");
        const {collection:collectionId, id:itemId} = item;
        const tilejson = await getTileJSON(collectionId, itemId, ["visual"]);
        const urlTemplate = tilejson.tiles?.[0];
        if(!urlTemplate) throw new Error("No tiles array in TileJSON");

        tileLayer = L.tileLayer(urlTemplate, {attribution: tilejson.attribution || "Microsoft Planetary Computer"}).addTo(map);
      }catch(e){
        console.warn("MPC tile failed, using local fallback:", e);
        document.getElementById('earthFallback').style.display='block';
      }

      // Add simple zoom buttons wiring to Leaflet
      document.getElementById('zoomIn').onclick = ()=> map.zoomIn();
      document.getElementById('zoomOut').onclick = ()=> map.zoomOut();
      document.getElementById('resetZoom').onclick = ()=> map.setView([20,0], 2);

      // Position zones by lat/lon
      function positionZones(){
        const overlay = document.getElementById('zoneOverlay');
        for(const [id,coord] of Object.entries(zoneCoords)){
          const el = document.getElementById(id);
          if(!el) continue;
          const pt = map.latLngToContainerPoint([coord.lat, coord.lon]);
          el.style.left = pt.x+'px';
          el.style.top  = pt.y+'px';
        }
      }
      map.on('move zoom', positionZones);
      positionZones(); // initial

      // Show temporal controls after first tile load
      document.getElementById('controls').style.display='block';
    }

    /* ---------- UI: time slider wiring to classes ---------- */
    let currentYear = 2025;
    const timeSlider = document.getElementById('timeSlider');
    const currentYearSpan = document.getElementById('currentYear');
    timeSlider.addEventListener('input', e=>{
      currentYear = parseInt(e.target.value,10);
      currentYearSpan.textContent = currentYear;
      updateMapForYear(currentYear);
    });

    function updateMapForYear(year){
      Object.keys(zoneData).forEach(zoneId=>{
        const el = document.getElementById(zoneId);
        const d = zoneData[zoneId].data[year];
        if(d){ el.className = `zone ${d.class}`; }
      });
    }

    /* ---------- Sidebar interactions ---------- */
    const sidebar = document.getElementById('sidebar');
    function showZoneInfo(data, zoneId){
      const yearData = data.data[currentYear] || Object.values(data.data)[0];
      document.getElementById('zoneName').textContent = `üõ∞Ô∏è ${data.name}`;

      const stressFill = document.getElementById('stressFill');
      const stressPercent = document.getElementById('stressPercent');
      stressFill.style.width = `${yearData.stress}%`;
      if(yearData.stress > 60){ stressFill.style.background='linear-gradient(90deg,#ff0000 0%,#ff6600 100%)'; }
      else if(yearData.stress > 40){ stressFill.style.background='linear-gradient(90deg,#ffaa00 0%,#ffdd00 100%)'; }
      else{ stressFill.style.background='linear-gradient(90deg,#00ff00 0%,#66ff66 100%)'; }
      stressPercent.textContent = `${yearData.stress}% STRESS LEVEL ‚Äî ${yearData.health.toUpperCase()}`;

      document.getElementById('plantHealth').innerHTML = `
        <div class="dominant-vegetation"><div class="icon">${data.dominantVegetation.icon}</div>
        <div class="label">${data.dominantVegetation.type}</div></div>
        System Status: ${yearData.health}`;

      const plantLegend = document.getElementById('plantLegend');
      plantLegend.innerHTML = data.plants.map(p=>`<div class="plant-item">${p}</div>`).join('');

      const suggestions = document.getElementById('suggestions');
      suggestions.innerHTML = data.suggestions.map(s=>`<li>üöÄ ${s}</li>`).join('');

      const prediction = document.getElementById('prediction');
      prediction.className = `prediction ${data.prediction.trend}`;
      prediction.innerHTML = `<p><strong>AI ANALYSIS:</strong> ${data.prediction.text}</p>`;

      sidebar.classList.add('active');
    }
    document.getElementById('closeSidebar').onclick = ()=>{
      sidebar.classList.remove('active');
    };

    // zone clicks
    document.querySelectorAll('.zone').forEach(z=>{
      z.addEventListener('click', e=>{
        const id = e.currentTarget.id;
        const data = zoneData[id];
        if(data) showZoneInfo(data, id);
      });
    });

    /* ---------- Data stream cosmetic ---------- */
    setInterval(()=>{
      const speed = (Math.random()*200+700).toFixed(1);
      document.getElementById('dataStream').textContent = `DATA STREAM: ${speed} MB/s`;
    }, 2000);

    /* ---------- Kickoff ---------- */
    updateMapForYear(currentYear);
    initMap();
  </script>
</body>
</html>
